#!/bin/sh
# This script facilitates the disaster recovery of CentOS7 on a Rubrik Cluster	

# Set some basic VARS

DNSSERVER="<%= @rubrikDR_DNS %>"
NAME=`nmcli -t -f NAME con sho`
DEV=`nmcli -t -f GENERAL.DEVICES c s "$NAME"| sed -r 's/^.*:(.*)$/\1/'`
IP="<%= @rubrikDR_IP %>"
GW="<%= @rubrikDR_GW %>"
FQDN=`facter fqdn`

# If I can't get out, try the failover IP

if ping -q -c 1 -W 1 $DNSSERVER >/dev/null; then 
 logger -s "rubrik - IP can get out, nothing to set"  
else 
 nmcli dev disconnect $DEV 
 nmcli con mod "$NAME" ip4 $IP gw4 $GW 
 logger -s "rubrik - Reconfiguring Interface"
 nmcli con up "$NAME"
fi

logger -s "rubrik - Update time"
/sbin/ntpdate -u pool.ntp.org

IPADDR=`nmcli -t --fields IP4.ADDRESS device show $DEV | sed -r 's/^.*:(.*)\/.*$/\1/'`
logger -s "rubrik - Modifying DNS for $FQDN to point to $IPADDR"

cat <<EOF | nsupdate -g | logger -s
server $DNSSERVER
prereq nxrrset $FQDN. CNAME
update delete $FQDN. A
update add $FQDN. 86400 A $IPADDR
send
EOF
